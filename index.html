<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ball on a Maze â€” Mayank Soni</title>
<meta name="theme-color" content="#0f0b12"/>
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{--bg:#071018;--accent:#ffd86b;--muted:#bfb6aa}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#05070a,#071018);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#fff;overflow:hidden}
.hidden{display:none!important}

/* Intro */
#introScreen{display:grid;place-items:center;min-height:100vh;padding:16px}
.card{position:relative;width:min(92vw,560px);background:linear-gradient(180deg,#0e0b10,#14131a);border:1px solid rgba(255,255,255,.08);padding:18px;border-radius:16px;text-align:center}
.small{font-size:.95rem;color:var(--muted)}
.btn{background:linear-gradient(180deg,#f6e3bf,#f1cf94);color:#24180f;padding:12px 16px;border:0;border-radius:14px;font-weight:800;touch-action:manipulation}
.row{display:flex;gap:10px;justify-content:center}
.preview{width:220px;height:120px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:#0b1620;margin-top:10px}
.game-title{font-family:Poppins,system-ui,sans-serif;font-weight:900;font-size:clamp(28px,7vw,56px);letter-spacing:1px;color:#fff8ec;margin:6px 0 10px;text-shadow:0 1px 0 #caa164,0 2px 0 #b58853,0 3px 0 #9d7546,0 4px 0 #7a5832,0 7px 10px rgba(0,0,0,.45),0 0 18px rgba(255,216,107,.22)}
.neon{font-family:"Courier New",monospace;font-weight:800;color:#d9ffff;display:inline-block;padding:6px 12px;border-radius:10px;border:1px solid rgba(53,234,255,.25);box-shadow:0 0 18px rgba(53,234,255,.15)}

/* App */
#app{display:flex;flex-direction:column;height:100%}
.header{height:62px;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#0ff,#068);display:flex;align-items:center;justify-content:center;font-weight:800;color:#051018}
.title{font-weight:700}
.icon{background:transparent;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:10px;color:#bfb6aa}
.canvas-wrap{flex:1;display:flex;padding:0}
canvas{display:block;border-radius:18px;touch-action:none;max-width:100%;pointer-events:auto}

/* HUD centered above buttons */
.hud{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:86px; background:rgba(0,0,0,.45);
  padding:8px 14px; border-radius:12px; font-weight:800; letter-spacing:.2px; z-index:110
}

/* Bigger floating Settings button */
#btnSettings{
  position:fixed; right:14px; bottom:14px; width:56px; height:56px; font-size:24px;
  border-radius:14px; background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.12); color:#fff; z-index:120;
  display:flex;align-items:center;justify-content:center
}

.floating{position:fixed;left:14px;bottom:14px;display:flex;gap:8px;z-index:60}
.level-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.cell{width:60px;height:60px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#0c0a10,#100e15)}
.cell.lock{opacity:.35;pointer-events:none}
.overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:99999}
.win-stars{font-size:1.2rem;color:#ffd86b}
.alert{position:fixed;left:50%;transform:translateX(-50%);top:70px;background:#231b1b;color:#ffd86b;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:10px;font-size:.9rem;z-index:70}
</style>
</head>
<body>

<section id="introScreen">
  <div class="card">
    <div class="game-title">BALL ON A MAZE</div>
    <div class="neon">Created by Mayank Soni</div>
    <div class="small" style="margin-top:10px">
      Tilt to roll the metal ball. If tilt isnâ€™t available, drag anywhere to steer. Finish levels to unlock the nextâ€”progress saves.
    </div>
    <div class="row" style="margin-top:12px">
      <button id="startGame" class="btn">Start Game</button>
      <button id="howTo" class="btn">How to Play</button>
    </div>
    <div class="preview" id="introPrev"></div>
  </div>
</section>

<section id="app" class="hidden" aria-hidden="true">
  <div id="secureNote" class="alert hidden">Tilt is unavailable in this context. Open over HTTPS (e.g., GitHub Pages) then enable in Settings.</div>

  <div class="header">
    <div class="brand">
      <div class="logo">BM</div>
      <div>
        <div class="title">Ball on a Maze</div>
        <div class="small">Created by <b>Mayank Soni</b></div>
      </div>
    </div>
    <div class="controls">
      <button id="btnLevels" class="icon">Levels</button>
      <button id="btnPreview" class="icon">Preview</button>
      <!-- NEW: Audio mode button -->
      <button id="btnAudio" class="icon" data-mode="synth">Audio: Synth</button>
    </div>
  </div>

  <div class="canvas-wrap"><canvas id="canvas"></canvas></div>
  <div class="hud">Lvl <span id="lvl">1/30</span> â€¢ Time: <span id="time">0.0</span>s</div>
  <div class="floating">
    <button id="btnContinue" class="btn">Continue</button>
    <button id="btnRestart" class="btn">Restart</button>
    <button id="btnPrev" class="btn">Prev</button>
    <button id="btnNext" class="btn">Next</button>
    <button id="btnSettings" class="icon">âš™</button>
  </div>

  <!-- Settings -->
  <div id="settings" class="overlay hidden">
    <div class="card">
      <h1>Settings & Calibration</h1>
      <div class="small">Tilt sensitivity</div>
      <input id="sens" type="range" min="0.4" max="2.4" step="0.05" value="1.0" style="width:100%;margin-top:6px">
      <div class="row" style="margin-top:10px">
        <button id="btnEnableMotion" class="btn">Enable Motion (Tilt)</button>
        <button id="btnCal" class="btn">Calibrate</button>
        <button id="btnInputMode" class="btn" data-mode="tilt">Input: Tilt</button>
        <button id="btnCloseSet" class="btn">Close</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnReset" class="btn">Reset Progress</button>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <div id="preview" class="overlay hidden">
    <div class="card">
      <h1>Level Preview</h1>
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div class="preview" id="previewBox"></div>
        <div style="flex:1">
          <div class="small" id="previewText">Previewing level 1</div>
          <div class="row" style="margin-top:10px)">
            <button id="btnStartLvl" class="btn">Start Level</button>
            <button id="btnClosePrev" class="btn">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Levels -->
  <div id="levels" class="overlay hidden">
    <div class="card">
      <h1>Select Level</h1>
      <div class="small">Locked levels unlock by finishing previous ones.</div>
      <div id="grid" class="level-grid"></div>
      <div class="row" style="margin-top:10px)">
        <button id="btnCloseLevels" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Win -->
  <div id="win" class="overlay hidden">
    <div class="card" style="text-align:center">
      <h1 id="winTitle">Level Complete!</h1>
      <div id="winInfo" class="small">Time 0.00s</div>
      <div id="winStars" class="win-stars">â˜… â˜… â˜…</div>
      <div class="row" style="margin-top:10px">
        <button id="btnNextWin" class="btn">Next</button>
        <button id="btnCloseWin" class="btn">Close</button>
      </div>
    </div>
  </div>
</section>

<!-- SFX -->
<audio id="sndWin"  src="assets/sfx/win.mp3"   preload="auto"></audio>
<audio id="sndFail" src="assets/sfx/slurp.mp3" preload="auto"></audio>
<audio id="sndBurn" src="assets/sfx/burn.mp3"  preload="auto"></audio>

<script>
/* ===== helpers ===== */
const $=id=>document.getElementById(id);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const TAU=Math.PI*2;

/* NEW: tiny sound helper */
function playSound(id){
  const el = $(id);
  if(!el) return;
  try { el.currentTime = 0; el.play().catch(()=>{}); } catch(e){}
}

/* ===== keep screen awake (Wake Lock) ===== */
let wakeLock = null, wakeTryTimer = null;
async function requestWakeLock(){
  try{
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{ if(!document.hidden) retryWakeLockSoon(); });
    }
  }catch(e){}
}
function retryWakeLockSoon(){ clearTimeout(wakeTryTimer); wakeTryTimer=setTimeout(()=>{ if(!document.hidden) requestWakeLock(); },1200); }
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden){ try{wakeLock?.release();}catch(e){} wakeLock=null; }
  else { retryWakeLockSoon(); }
});

/* small intro */
(function(){
  const go = () => {
    try{
      $('introScreen').classList.add('hidden');
      $('app').classList.remove('hidden');
      bootGame();

      requestWakeLock(); // NEW: keep screen on

      /* Harder portrait lock: try fullscreen â†’ lock; relock on change */
      (async () => {
        try {
          if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen({navigationUI:'hide'}).catch(()=>{});
          }
          if (screen.orientation?.lock) {
            await screen.orientation.lock('portrait-primary').catch(()=>{});
          }
        } catch(e){}
      })();

      addEventListener('orientationchange', () => {
        screen.orientation?.lock?.('portrait-primary').catch(()=>{});
      });

      /* Auto-enable motion sensors after Start */
      requestMotion()
        .then(() => {
          addEventListener('devicemotion', handleMotion, true);
          addEventListener('deviceorientation', handleOrientation, true);
        })
        .catch(()=>{});

      /* Ensure WebAudio can run after user gesture */
      try{ audioAC.resume?.(); }catch(e){}

    }catch(e){ console.error(e); alert('Startup error: '+e.message); }
  };
  $('startGame').addEventListener('click',go,{passive:false});
  $('startGame').onclick = go;
  $('howTo').addEventListener('click',()=>alert('Tilt (over HTTPS) or drag anywhere to steer. Stay in the dark corridors; reach the red end hole.'),{passive:true});

  addEventListener('load',()=>{
    const box=$('introPrev'),c=document.createElement('canvas');box.appendChild(c);
    const DPR=window.devicePixelRatio||1,w=box.clientWidth,h=box.clientHeight; c.width=w*DPR;c.height=h*DPR;c.style.width=w+'px';c.style.height=h+'px';
    const g=c.getContext('2d'), L=["#########","#S.....G#","###.###.#","#...#...#","###.###.#","#.......#","#########"];
    const R=L.length,C=L[0].length,pad=Math.min(c.width,c.height)*.06;const cell=Math.floor((Math.min(c.width,c.height)-pad*2)/Math.max(R,C));
    const sx=Math.floor((c.width-cell*C)/2), sy=Math.floor((c.height-cell*R)/2);
    g.fillStyle='#0b1620';g.fillRect(0,0,c.width,c.height);
    for(let r=0;r<R;r++)for(let cc=0;cc<C;cc++){
      const ch=L[r][cc],x=sx+cc*cell,y=sy+r*cell;
      if(ch=='#'){
        const mm=Math.floor(cell*0.10),rx=x+mm,ry=y+mm,ww=cell-2*mm,hh=cell-2*mm,rad=Math.floor(Math.min(ww,hh)*0.22);
        g.fillStyle='#6b4a2d';g.beginPath();
        g.moveTo(rx+rad,ry);g.arcTo(rx+ww,ry,rx+ww,ry+hh,rad);
        g.arcTo(rx+ww,ry+hh,rx,ry+hh,rad);
        g.arcTo(rx,ry+hh,rx,ry,rad);
        g.arcTo(rx,ry,rx+ww,ry,rad);
        g.closePath();g.fill();
      }else{
        if(ch==='S') g.fillStyle='#4fe6ff';
        else if(ch==='G') g.fillStyle='#ff6060';
        else g.fillStyle='#142a36';
        g.fillRect(x,y,cell,cell);
      }
    }
  });
})();

/* ===== state ===== */
let DPR=1,canvas,ctx,rows,cols,cell,padX,padY,walls,start,goal,pits,gridW=0,gridH=0;
let tileWall=[];
let ball,t0,elapsed=0,running=false,sens=1.0,level=0,unlocked=parseInt(localStorage.getItem('bm_unlocked')||'1',10)||1;
let tiltX=0,tiltY=0,rawX=0,rawY=0,smX=0,smY=0,offsetB=0,offsetG=0;
const LP=0.28,DEAD=0.01;
/* tuned physics */
const GRAVITY=1600, FRICTION=0.996, ANG_DAMP=0.96, MAX_SPEED=3400, FINGER_K=520, FINGER_MAX_ACC=1400;
let dragging=false,dragTarget=null,falling=false,fallT=0;

/* NEW hazards state */
let fires = [];          // {x,y,r,animSeed}
let teleporters = [];    // [{x,y,r,pair:index}]
let teleCooldown = 0;

/* ===== visual THEMES ===== */
const THEMES=[
  { bg1:'#21160f', bg2:'#3a2616', brick1:'#6c4b2d', brick2:'#4a311c', glow:'#ffe896', wave:'triangle', base:196, scale:[1,1.122,1.26,1.335,1.5,1.681,1.887] },
  { bg1:'#0e1624', bg2:'#162033', brick1:'#405a7a', brick2:'#2e415a', glow:'#9ed3ff', wave:'sine',     base:220, scale:[1,1.189,1.334,1.498,1.681,1.887,2.0] },
  { bg1:'#1a0f21', bg2:'#2a1833', brick1:'#7a405f', brick2:'#5a2e46', glow:'#ff9ed3', wave:'square',   base:247, scale:[1,1.122,1.26,1.335,1.498,1.681,1.887] },
  { bg1:'#0f1f14', bg2:'#183326', brick1:'#3e7051', brick2:'#2c5039', glow:'#a7ffc8', wave:'triangle', base:165, scale:[1,1.2,1.34,1.5,1.6,1.8,2.0] },
  { bg1:'#201d10', bg2:'#3a341a', brick1:'#8b7a39', brick2:'#6d5f2d', glow:'#fff2a0', wave:'sawtooth', base:185, scale:[1,1.12,1.25,1.33,1.5,1.68,1.9] }
];
let THEME = THEMES[0];

/* ===== levels ===== (now full 30) */
const ROUNDED=[
  ["#########","#S.....G#","###.###.#","#...#...#","###.###.#","#.......#","#########"],
  ["###########","#S.....#..#","###.###.#G#","#...#.....#","#.#.#####.#","#.#.......#","###########"],
  ["###########","#S.....#..#","###.###.#.#","#...#...#G#","#.###.###.#","#.........#","###########"],
  ["#############","#S..#....#..#","##.#.##.#.#G#","#..#....#...#","##.######.#.#","#..........#","#############"],
  ["#############","#S..#....#..#","##.#.##.#.#.#","#..#....#..G#","##.######.#.#","#..........#","#############"]
];
const GRID=[
  ["###################","#S   #   #   #   G#","### ### # ### ### #","#   #   #   #   # #","# ### ### ### ### #","#   #   #   #   # #","### # ### # ### # #","#   #     #     # #","###################"],
 [
  "#############################",
  "#S   # #   #   ###   #   # G#",
  "### # # # # # # # # ### # ###",
  "#   #   #   #   #   #   #   #",
  "# ### ### # ### # ### ### ###",
  "#   #   # #   # #   #   #   #",
  "### # ### ### # ### ### # ###",
  "#   #   #   # #   #   # #   #",
  "#############################"
],
  ["###############","#S     #     G#","# ### ### ### #","#   #   #   # #","### # ### # # #","#   #   # #   #","# ### # # ### #","#   H         #","###############"],
  ["###################","#S   #   #   #   G#","### # # ### # ### #","#   # #   # #   # #","# ### ### ### ### #","#     #  H  #     #","### # ### # ### # #","# H #   #   #   # #","###################"],
  ["#####################","#S   #   #   #   # G#","### # ### # ### # ###","#   #   # #   # #   #","# ##### # # ### ### #","#  H  # # #   #   # #","##### # # ### # # # #","#     #   # H #   # #","#####################"],
  ["#########################","#S   #   #   #   #     G#","### ### ### ### ### #####","#   #   #   #   #   #  H#","### # ### # ### # ### # #","#   #   # #   # #   # # #","# ##### # ### # ### # # #","#   H # #   H #   #   # #","#########################"],
  ["###########################","#S   # #   #   #   #   # G#","### # # # # # # # # # # ###","#   #   # H #   #   #   # #","# # ##### ##### ##### # # #","# #     #     #     # # # #","# ##### # ### # ### # # # #","#   H #   # #   # #   # H #","###########################"],
  ["###########################","#S  ###   ###   ###     G#","# # # # # # # # # # ### # #","# # # # # # # # # #   # # #","#   ###   ###   ### ###   #","###   # #   # #   #   # ###","# H #   # #   # #   # #  H#","### ### ### ### ### ### ###","###########################"],
  ["#############################","#S   #   #   ###   #     # G#","### # # ### # # ### # # # ###","#   # #   # #   #   # # #  H#","# ### ### # ##### ### # ### #","#   #   # #     #   # #   # #","### # # # ##### ### # ### # #","# H # #   #   #   #   #  H# #","#############################"],
  ["#############################","#S       #   ###   #       G#","### ##### # # # # ### ##### #","#   #   # # #   # #   #   # #","# ### # # # ##### # ### # # #","#   # # # #  H  # #   # # # #","### # # ### ### ### ### # ###","#  H  #     #   #     #   H #","#############################"],
  ["###################","#S   #     #   H G#","### ### ### ### ###","#   #   #   #   # #","# ### # ### # ### #","#   # #   # #   # #","### # ### # ### # #","# H #     #   H # #","###################"],
  ["#####################","#S   # #   #   #   G#","### # # ### ### # ###","#   #   #   #   #  H#","# ##### # ### ##### #","#     # #   #     # #","### # ### ### ### # #","# H #     #   H #   #","#####################"],
  ["#########################","#S     #   #   #   #   G#","### ### ### # ### ### ###","#   #   #   #   #   # H #","# ### ##### ### ##### ###","#   #   H #   #     #   #","### # ### ##### ### # ###","# H #   #     #   #   H #","#########################"],
  ["#########################","#S   #   #   #   #     G#","### # ### # ### # ### ###","#   #   # #   # #   #   #","# ##### # ### # ##### ###","#     # #   # #   H #   #","### # ### # ### ### # ###","# H #   #   # H #   #  H#","#########################"],
  ["###################","#S #   #   #   # G#","# # ### # ### # # #","# #   # #   # # # #","# ### # ### # # ###","#   # #   # # #  H#","### # ### # ### # #","# H #  H  #   H # #","###################"],
  ["#####################","#S   #     #     # G#","### ### ### ### ### #","#   #   #   #   #  H#","# ### # ### # ### ###","#   # #   # #   # H #","### # ### # ### # ###","# H #   H #   H #   #","#####################"],
  ["#########################","#S   #   ##  #  ##   # G#","### ### #### # #### ### #","#   #   #  # # #  # #  H#","# ### ### ## # ## ### ###","#   #   #    #    #   # #","### # ### ######## ### # #","# H #     #  H   #   H # #","#########################"],
  ["###################","#S   # #   #   # G#","### # # # ### ### #","#   #   #   #   # #","# ### ##### # ### #","#   #   H # #   # #","### ### # ### # # #","# H   H #   H #  H#","###################"],
  ["#####################","#S #   #   #   #   G#","# # ### ### ### ### #","# #   #   #   #   # #","# ### # ### ### # ###","#   # #   # H # #   #","### # ### # ### ### #","# H # H # #   H # H #","#####################"],
  ["#########################","#S     #   #   #     # G#","### ### # ### # ### ### #","#   #   #   # #   #   # #","# ### ##### # ##### ### #","#   #   H # #   H #   # #","### # ### # # ### # ### #","# H #   #   # H #   # H #","#########################"],
  ["#############################","#S   #   #   #   #   #   # G#","### ### ### # ### # ### ### #","#   #   #   #   # #   #   # #","# ### # ### ### # ### ### # #","#   # #   #   # #   #   # # #","### # ### # ### ### # ### # #","# H #   H #   H #   H #   H #","#############################"],
  ["###################","#S     #   #     G#","### ### ### ### ###","#   #   #   #   # #","# ### # ### # ### #","# H # # H # # H # #","### # ### # ### # #","# H #   H #   H # #","###################"],
  ["#####################","#S   # #   #   #   G#","### # # ### ### # ###","#   #   #   #   #  H#","# ### ### # ### ### #","# H #   # #   #   # #","### # # ### ### # ###","# H # # H # H # # H #","#####################"],
  ["#########################","#S   #   #     #   #   G#","### ### ### ### ### ### #","#   #   #   #   #   # H #","# ### # ### # ### # ### #","# H # #   # #   # #   # #","### # ### # ### # ### # #","# H #   H #   H #   H # #","#########################"],
  ["#############################","#S     #   #   ###   #     G#","### ### # # # # # # ### ### #","#   #   # # #   # #   #   # #","# ### ### # ##### # ### ### #","# H #   # #     # #   #   # #","### # ### ### # ### ### # ###","# H #   H   # #   H   # # H #","#############################"]
];
const LEVELS=[...ROUNDED,...GRID];

/* rotation */
function rotateMapClockwise(map){
  const R=map.length, C=map[0].length;
  const out=Array.from({length:C},()=>Array(R).fill(' '));
  for(let r=0;r<R;r++)for(let c=0;c<C;c++) out[c][R-1-r]=map[r][c];
  return out.map(row=>row.join(''));
}

/* ---- path helpers ---- */
function findChar(map, ch){
  for (let r=0;r<map.length;r++){
    const c = map[r].indexOf(ch);
    if (c !== -1) return {r, c};
  }
  return null;
}
function hasPath(map){
  const R=map.length, C=map[0].length;
  const sr=findChar(map,'S'), gr=findChar(map,'G'); if(!sr||!gr) return false;
  const q=[[sr.r,sr.c]], seen=new Set([sr.r+','+sr.c]);
  const ok = (r,c)=>r>=0&&c>=0&&r<R&&c<C && map[r][c]!=='#' && map[r][c]!=='H' && map[r][c]!=='R';
  while(q.length){
    const [r,c]=q.shift();
    if(r===gr.r && c===gr.c) return true;
    [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr,dc])=>{
      const nr=r+dr, nc=c+dc, k=nr+','+nc;
      if(!seen.has(k) && ok(nr,nc)){ seen.add(k); q.push([nr,nc]); }
    });
  }
  return false;
}

/* Minimal connector (respects H/R) */
function minimallyConnect(map){
  const R=map.length, C=map[0].length;
  const S=findChar(map,'S'), G=findChar(map,'G');
  if(!S||!G) return map;
  const grid=map.map(r=>r.split(''));
  const inb=(r,c)=>r>=0&&c>=0&&r<R&&c<C;
  const dist=Array.from({length:R},()=>Array.from({length:C},()=>[Infinity,Infinity,Infinity]));
  const prev=new Map(); const key=(r,c,k)=>r+','+c+','+k;
  const pq=[]; const push=(r,c,k,d)=>{dist[r][c][k]=d;pq.push([d,r,c,k]);pq.sort((a,b)=>a[0]-b[0]);};
  push(S.r,S.c,0,0);

  while(pq.length){
    const [d,r,c,k]=pq.shift();
    if(d!==dist[r][c][k]) continue;
    if(r===G.r && c===G.c) {
      let cr=r, cc=c, ck=k; const opened=[];
      while(!(cr===S.r && cc===S.c && ck===0)){
        const p=prev.get(key(cr,cc,ck)); if(!p) break;
        const [pr,pc,pk]=p;
        if(grid[cr][cc]==='#'){ opened.push([cr,cc]); }
        cr=pr; cc=pc; ck=pk;
      }
      opened.forEach(([rr,cc])=>{ if(grid[rr][cc]==='#') grid[rr][cc]=' '; });
      return grid.map(row=>row.join(''));
    }
    for(const [dr,dc] of [[1,0],[-1,0],[0,1],[0,-1]]){
      const nr=r+dr, nc=c+dc;
      if(!inb(nr,nc)) continue;
      const ch=grid[nr][nc];
      if(ch==='H'||ch==='R') continue;
      const breakCost = (ch==='#') ? 1 : 0;
      const nk = Math.min(2, k + breakCost);
      const nd = d + breakCost;
      if(nd < dist[nr][nc][nk]){
        prev.set(key(nr,nc,nk), [r,c,k]);
        push(nr,nc,nk,nd);
      }
    }
  }
  return map;
}

/* >>> FIX: strict placement with guaranteed connection to bottom-right-most open cell */
function ensureStartLeftOfGoalStrict(map){
  const R=map.length, C=map[0].length;
  let g = map.map(r=>r.split(''));

  const free=(r,c)=>r>=0&&c>=0&&r<R&&c<C && g[r][c]!=='#' && g[r][c]!=='H' && g[r][c]!=='R';

  // clear old S/G
  for(let r=0;r<R;r++)for(let c=0;c<C;c++){
    if(g[r][c]==='S'||g[r][c]==='G') g[r][c]=' ';
  }

  // S: first free scanning TL â†’ BR
  let S=null;
  outerS: for(let r=0;r<R;r++)for(let c=0;c<C;c++){
    if(free(r,c)){ S={r,c}; break outerS; }
  }
  if(!S) return map;

  // candidate G: last free scanning BR â†’ TL
  let G=null;
  outerG: for(let r=R-1;r>=0;r--)for(let c=C-1;c>=0;c--){
    if(free(r,c)){ G={r,c}; break outerG; }
  }
  if(!G) return map;

  // carve minimal path from S to G (respect H/R)
  const dist=Array.from({length:R},()=>Array.from({length:C},()=>[Infinity,Infinity,Infinity]));
  const prev=new Map(); const key=(r,c,k)=>r+','+c+','+k;
  const pq=[]; const push=(r,c,k,d)=>{dist[r][c][k]=d;pq.push([d,r,c,k]);pq.sort((a,b)=>a[0]-b[0]);};
  push(S.r,S.c,0,0);

  const inb=(r,c)=>r>=0&&c>=0&&r<R&&c<C;

  while(pq.length){
    const [d,r,c,k]=pq.shift();
    if(d!==dist[r][c][k]) continue;
    if(r===G.r && c===G.c){
      // carve along the found path
      let cr=r, cc=c, ck=k;
      while(!(cr===S.r && cc===S.c && ck===0)){
        const p=prev.get(key(cr,cc,ck)); if(!p) break;
        const [pr,pc,pk]=p;
        if(g[cr][cc]==='#') g[cr][cc]=' ';
        cr=pr; cc=pc; ck=pk;
      }
      g[S.r][S.c]='S'; g[G.r][G.c]='G';
      return g.map(row=>row.join(''));
    }
    for(const [dr,dc] of [[1,0],[ -1,0],[0,1],[0,-1]]){
      const nr=r+dr, nc=c+dc;
      if(!inb(nr,nc)) continue;
      const ch=g[nr][nc];
      if(ch==='H'||ch==='R') continue; // never break pits
      const breakCost = (ch==='#') ? 1 : 0;
      const nk=Math.min(2,k+breakCost), nd=d+breakCost;
      if(nd<dist[nr][nc][nk]){ prev.set(key(nr,nc,nk),[r,c,k]); push(nr,nc,nk,nd); }
    }
  }
  // fallback
  g[S.r][S.c]='S'; g[G.r][G.c]='G';
  return g.map(row=>row.join(''));
}

/* Shortest path (BFS) ignoring pits; returns [{r,c}...] */
function shortestPath(map){
  const R=map.length, C=map[0].length;
  const S=findChar(map,'S'), G=findChar(map,'G'); if(!S||!G) return [];
  const ok=(r,c)=>r>=0&&c>=0&&r<R&&c<C && map[r][c]!=='#';
  const q=[[S.r,S.c]], prev=new Map(), key=(r,c)=>r+','+c;
  const seen=new Set([key(S.r,S.c)]);
  while(q.length){
    const [r,c]=q.shift();
    if(r===G.r && c===G.c){
      const out=[]; let rr=r, cc=c;
      while(!(rr===S.r&&cc===S.c)){ out.push({r:rr,c:cc}); const p=prev.get(key(rr,cc)); if(!p)break; [rr,cc]=p; }
      out.push(S); out.reverse(); return out;
    }
    [[1,0],[-1,0],[0,1],[0,-1]].forEach(([dr,dc])=>{
      const nr=r+dr,nc=c+dc,k=key(nr,nc);
      if(!seen.has(k)&&ok(nr,nc)){ seen.add(k); prev.set(key(nr,nc),[r,c]); q.push([nr,nc]); }
    });
  }
  return [];
}

/* ===== Dynamic hazards seeding based on level ===== */
function seedDynamicHazards(map){
  const lv = level + 1;
  if (lv <= 5) return map;

  const needR = lv;                   // red pits
  const needH = Math.floor(lv/2);     // brown pits
  const needF = (lv > 10) ? Math.floor(lv/2) : 0; // fire
  const teleNodes = (lv > 15) ? (2 * (lv - 15)) : 0; // ðŸš« nodes

  let g = map.map(r=>r.split(''));
  const path = shortestPath(map);
  if (path.length < 4) return map;

  const R = g.length, C = g[0].length;
  const inb = (r,c)=>r>=0&&c>=0&&r<R&&c<C;
  const empty = (r,c)=> inb(r,c) && g[r][c]===' ';
  const candidates = [];

  for(let i=1;i<path.length;i++){
    const a=path[i-1], b=path[i];
    const dirH = (b.r===a.r);
    const base = b;
    (dirH ? [[1,0],[-1,0]] : [[0,1],[0,-1]]).forEach(([dr,dc])=>{
      const rr = base.r + dr, cc = base.c + dc;
      if (empty(rr,cc)) candidates.push({r:rr,c:cc});
    });
  }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
  const used = new Set(); const key=(r,c)=>r+','+c;

  function safePlace(ch, count){
    let placed=0; const pool=shuffle([...candidates]);
    while(placed<count && pool.length){
      const spot=pool.shift(), k=key(spot.r,spot.c);
      if (used.has(k) || !empty(spot.r,spot.c)) continue;
      const before=g.map(row=>row.join(''));
      g[spot.r][spot.c]=ch;
      if(!hasPath(g.map(row=>row.join('')))){ g=before.map(row=>row.split('')); continue; }
      used.add(k); placed++;
    }
  }

  // place in order of danger
  safePlace('R', needR);
  safePlace('H', needH);
  safePlace('F', needF);
  safePlace('T', teleNodes);

  return g.map(row=>row.join(''));
}

/* ===== boot & layout ===== */
function bootGame(){
  const insecure=!window.isSecureContext||/^file|content/i.test(location.protocol);
  if(insecure)$('secureNote').classList.remove('hidden');
  canvas=$('canvas'); ctx=canvas.getContext('2d');
  DPR=Math.max(1,window.devicePixelRatio||1);
  addEventListener('resize',()=>build(level));
  build(Math.max(0,(parseInt(localStorage.getItem('bm_continue')||String(unlocked),10)-1)));
  wireUI(); wireInput();
  running=true; startLoop();
}
function sizeCanvas(){
  const headerH=62, bottomReserve=118;
  const availW=Math.max(340, innerWidth-10);
  const availH=Math.max(520, innerHeight-(headerH+bottomReserve));
  canvas.style.width=availW+'px'; canvas.style.height=availH+'px';
  canvas.width=Math.floor(availW*DPR); canvas.height=Math.floor(availH*DPR);
}

/* ===== MOTION / INPUT ===== */
let inputMode = localStorage.getItem('bm_input') || 'tilt';
let offsetX = parseFloat(localStorage.getItem('bm_offX') || '0');
let offsetY = parseFloat(localStorage.getItem('bm_offY') || '0');
let lastOriTS = 0;

function requestMotion(){
  if (typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
    return DeviceMotionEvent.requestPermission()
      .then(() => (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function')
        ? DeviceOrientationEvent.requestPermission() : 'granted');
  } else if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    return DeviceOrientationEvent.requestPermission();
  }
  return Promise.resolve('granted');
}

function mapByOrientation(beta=0, gamma=0){
  const type = screen.orientation?.type ||
               ((screen.orientation?.angle===90)  ? 'landscape-primary' :
                (screen.orientation?.angle===270) ? 'landscape-secondary' :
                                                     'portrait-primary');
  let ax=0, ay=0;
  if (type.startsWith('portrait')){
    if (type.includes('secondary')) { ax = -gamma; ay = -beta; }
    else                            { ax =  gamma; ay =  beta; }
  } else {
    if (type.includes('secondary')) { ax = -beta; ay =  gamma; }
    else                            { ax =  beta; ay = -gamma; }
  }
  window._rawAX = ax; window._rawAY = ay;
  return { x: clamp((ax - offsetX)/45, -1, 1), y: clamp((ay - offsetY)/45, -1, 1) };
}

function handleOrientation(e){
  const m = mapByOrientation(e.beta ?? 0, e.gamma ?? 0);
  rawX = m.x; rawY = m.y;
  lastOriTS = performance.now();
}

function handleMotion(e){
  if (performance.now() - lastOriTS < 120) return;
  const ag = e.accelerationIncludingGravity; if (!ag) return;
  const axDeg = Math.atan2( ag.x || 0,  9.8) * 180/Math.PI;
  const ayDeg = Math.atan2(-(ag.y || 0), 9.8) * 180/Math.PI;
  const m = { x: clamp((axDeg - offsetX)/45,-1,1), y: clamp((ayDeg - offsetY)/45,-1,1) };
  rawX = m.x; rawY = m.y;
}

(function sensorTick(){
  const tgtX = (inputMode==='tilt') ? rawX : 0;
  const tgtY = (inputMode==='tilt') ? rawY : 0;
  smX += (tgtX - smX) * LP;
  smY += (tgtY - smY) * LP;
  tiltX = (Math.abs(smX) < DEAD) ? 0 : smX;
  tiltY = (Math.abs(smY) < DEAD) ? 0 : smY;
  requestAnimationFrame(sensorTick);
})();

/* ===== AUDIO ===== */
let audioMode = localStorage.getItem('bm_audio_mode') || 'synth';
const btnAudio = $('btnAudio'); btnAudio.dataset.mode=audioMode; btnAudio.textContent='Audio: '+(audioMode==='mp3'?'MP3':audioMode==='synth'?'Synth':'Off');

let bgAudio = new Audio(); bgAudio.loop = true; bgAudio.preload = 'auto'; bgAudio.volume = 0.35;

const MP3_MAP = [
  {min:1,  max:5,  file:'assets/music/track-1-5.mp3'},
  {min:6,  max:10, file:'assets/music/track-6-10.mp3'},
  {min:11, max:15, file:'assets/music/track-11-15.mp3'},
  {min:16, max:20, file:'assets/music/track-16-20.mp3'},
  {min:21, max:25, file:'assets/music/track-21-25.mp3'},
  {min:26, max:30, file:'assets/music/track-26-30.mp3'},
];
function trackForLevel(idx){
  const lv = idx + 1;
  const row = MP3_MAP.find(r => lv >= r.min && lv <= r.max) || MP3_MAP[0];
  return row.file;
}

const AC=window.AudioContext||window.webkitAudioContext;
const audioAC = new AC();
const gMain=audioAC.createGain(); gMain.gain.value=1; gMain.connect(audioAC.destination);
const gBG=audioAC.createGain(); gBG.gain.value=0.22; gBG.connect(gMain);
let synthTimer=null, synthNodes=[];
function stopSynth(){ if(synthTimer){ clearTimeout(synthTimer); synthTimer=null; } synthNodes.forEach(n=>{ try{n.stop(0)}catch{} }); synthNodes.length=0; }
function playSynth(idx){
  stopSynth(); if(audioMode==='off')return;
  const th = THEMES[idx % THEMES.length];
  const base = th.base, scale = th.scale;
  const chord=[[0,2,4],[1,3,5],[0,2,4,6]]; const prog=[0,1,0,2]; let step=0;
  (function schedule(){
    const t=audioAC.currentTime; const degrees=chord[prog[step%prog.length]];
    degrees.forEach(d=>{
      const o=audioAC.createOscillator(); o.type=th.wave;
      const g=audioAC.createGain(); g.gain.value=.0001;
      o.frequency.value=base*scale[d%scale.length];
      o.connect(g); g.connect(gBG);
      const st=t, ed=t+4.0; o.start(st);
      g.gain.linearRampToValueAtTime(.08,st+.25);
      g.gain.linearRampToValueAtTime(.04,ed-.6);
      g.gain.exponentialRampToValueAtTime(.001,ed); o.stop(ed);
      synthNodes.push(o);
    });
    for(let i=0;i<3;i++){
      const o=audioAC.createOscillator(); o.type='sine';
      const g=audioAC.createGain(); g.gain.value=.0001;
      const deg=(i*2+step)%scale.length;
      o.frequency.value=base*scale[deg];
      o.connect(g); g.connect(gBG);
      const st=t+.2+i*.35, ed=st+.55; o.start(st);
      g.gain.linearRampToValueAtTime(.06,st+.04);
      g.gain.exponentialRampToValueAtTime(.001,ed); o.stop(ed);
      synthNodes.push(o);
    }
    step++; synthTimer=setTimeout(schedule,3800);
  })();
}

function stopLevelMusic(){ try{ bgAudio.pause(); }catch{} stopSynth(); }
async function playLevelMusic(idx){
  stopLevelMusic();
  if(audioMode==='off') return;
  if(audioMode==='mp3'){
    bgAudio.src = trackForLevel(idx);
    try{ await bgAudio.play(); }catch(e){ }
    return;
  }
  if(audioMode==='synth'){ playSynth(idx); return; }
}

btnAudio.addEventListener('click',()=>{
  audioMode = (audioMode==='mp3') ? 'synth' : (audioMode==='synth' ? 'off' : 'mp3');
  localStorage.setItem('bm_audio_mode', audioMode);
  btnAudio.dataset.mode=audioMode;
  btnAudio.textContent='Audio: '+(audioMode==='mp3'?'MP3':audioMode==='synth'?'Synth':'Off');
  playLevelMusic(level);
});

/* ===== BUILD ===== */
function build(i){
  sizeCanvas();
  level=clamp(i,0,LEVELS.length-1);
  THEME = THEMES[level % THEMES.length];

  let map=LEVELS[level];

  if (level===4) { map = rotateMapClockwise(map); }
  const portrait = canvas.height >= canvas.width;
  if (portrait) { map = rotateMapClockwise(map); }

  // S/G then path, then NEW hazard seeding
  map = ensureStartLeftOfGoalStrict(map);
  if (!hasPath(map)) { map = minimallyConnect(map); }
  map = seedDynamicHazards(map); // NEW

  rows=map.length; cols=map[0].length;

  const mg=26*(window.devicePixelRatio||1), W=canvas.width-mg*2, H=canvas.height-mg*2;
  cell=Math.floor(H/rows); if(cell*cols>W) cell=Math.floor(W/cols);
  gridW=cell*cols; gridH=cell*rows;
  padX=Math.floor((canvas.width-gridW)/2); padY=Math.floor((canvas.height-gridH)/2);

  walls=[]; pits=[]; start=null; goal=null; falling=false; fallT=0;
  fires=[]; teleporters=[]; teleCooldown=0; // NEW
  tileWall=Array.from({length:rows},()=>Array(cols).fill(false));

  const teleTmp=[];
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const ch=map[r][c],x=padX+c*cell,y=padY+r*cell;
    if(ch=='#'){walls.push({x,y,w:cell,h:cell}); tileWall[r][c]=true;}
    else if(ch=='S'){start={x:x+cell/2,y:y+cell/2};}
    else if(ch=='G'){goal={x:x+cell/2,y:y+cell/2,r:cell*0.42};}
    else if(ch=='H'||ch=='R'){pits.push({x:x+cell/2,y:y+cell/2,r:cell*0.32, red:(ch==='R')});}
    else if(ch=='F'){fires.push({x:x+cell/2,y:y+cell/2,r:cell*0.30,animSeed:(r*997+c*421)%1000});}
    else if(ch=='T'){teleTmp.push({x:x+cell/2,y:y+cell/2,r:cell*0.28});}
  }
  // pair teleporters in order: 1<->2, 3<->4, ...
  for(let i=0;i<teleTmp.length;i+=2){
    const a=teleTmp[i], b=teleTmp[i+1];
    if(!a||!b) break;
    const base = teleporters.length;
    teleporters.push({...a, pair: base+1});
    teleporters.push({...b, pair: base});
  }

  ball={x:start.x,y:start.y,r:Math.max(8*(window.devicePixelRatio||1),Math.floor(cell*0.28)),vx:0,vy:0,spin:0,angVel:0};
  if(cell<36*(window.devicePixelRatio||1)) ball.r=Math.max(6*(window.devicePixelRatio||1),Math.floor(cell*0.22));

  t0=performance.now(); elapsed=0;
  $('lvl').textContent=`${level+1}/${LEVELS.length}`; $('time').textContent='0.0';

  draw(); playLevelMusic(level);
}

/* collisions */
function clampToField(x,y){
  const minX=padX+ball.r, maxX=padX+gridW-ball.r;
  const minY=padY+ball.r, maxY=padY+gridH-ball.r;
  return {x:clamp(x,minX,maxX), y:clamp(y,minY,maxY)};
}
function resolveTile(nx,ny,rc,cc){
  if(rc<0||cc<0||rc>=rows||cc>=cols||!tileWall[rc][cc]) return {nx,ny,hit:false};
  const margin=cell*0.08;
  const x=padX+cc*cell+margin, y=padY+rc*cell+margin, w=cell-2*margin, h=cell-2*margin;
  const cx=clamp(nx,x,x+w), cy=clamp(ny,y,y+h);
  const dx=nx-cx, dy=ny-cy, d2=dx*dx+dy*dy, min=ball.r;
  if(d2>=min*min) return {nx,ny,hit:false};
  const d=Math.max(1e-5,Math.sqrt(d2)), nxn=dx/d, nyn=dy/d;
  const push=min-d+0.01; nx+=nxn*push; ny+=nyn*push;
  const vn=ball.vx*nxn+ball.vy*nyn; if(vn<0){ball.vx-=vn*nxn;ball.vy-=vn*nyn;}
  return {nx,ny,hit:true};
}
function sweepAndResolve(nx,ny,dx,dy){
  const dist=Math.hypot(dx,dy), maxStep=ball.r*0.4, steps=Math.max(1,Math.ceil(dist/maxStep));
  const sx=dx/steps, sy=dy/steps;
  for(let s=0;s<steps;s++){
    nx+=sx; ny+=sy;
    ({x:nx,y:ny}=clampToField(nx,ny));
    const r0=Math.max(0,Math.floor((ny-ball.r - padY)/cell));
    const r1=Math.min(rows-1,Math.floor((ny+ball.r - padY)/cell));
    const c0=Math.max(0,Math.floor((nx-ball.r - padX)/cell));
    const c1=Math.min(cols-1,Math.floor((nx+ball.r - padX)/cell));
    for(let it=0;it<6;it++){
      let changed=false;
      for(let r=r0;r<=r1;r++)for(let c=c0;c<=c1;c++){
        const res=resolveTile(nx,ny,r,c); if(res.hit){nx=res.nx;ny=res.ny;changed=true;}
      }
      if(!changed) break;
    }
  }
  return {nx,ny};
}

/* physics */
function step(dt){
  if(falling){
    fallT+=dt;
    ball.x+=(goal.x-ball.x)*Math.min(1,dt*6);
    ball.y+=(goal.y-ball.y)*Math.min(1,dt*6);
    ball.r*=(1-Math.min(.85*dt,.12));
    if(fallT>0.45){win(); falling=false;}
    return;
  }

  const ax=sens*tiltX*GRAVITY, ay=sens*tiltY*GRAVITY;

  let fx=0, fy=0;
  if(dragTarget){
    const dx=dragTarget.x-ball.x, dy=dragTarget.y-ball.y;
    fx=clamp(dx*FINGER_K, -FINGER_MAX_ACC, FINGER_MAX_ACC);
    fy=clamp(dy*FINGER_K, -FINGER_MAX_ACC, FINGER_MAX_ACC);
  }

  ball.vx += (ax+fx)*dt;
  ball.vy += (ay+fy)*dt;

  const sp=Math.hypot(ball.vx,ball.vy);
  if(sp>MAX_SPEED){ const k=MAX_SPEED/sp; ball.vx*=k; ball.vy*=k; }

  const nx0=ball.x, ny0=ball.y;
  let nx=ball.x+ball.vx*dt, ny=ball.y+ball.vy*dt;
  ({nx,ny}=sweepAndResolve(nx0,ny0,nx-nx0,ny-ny0));

  const fr=Math.pow(FRICTION,dt*60); ball.vx*=fr; ball.vy*=fr; ball.angVel*=Math.pow(ANG_DAMP,dt*60); ball.spin+=ball.angVel*dt;

  ball.x=nx; ball.y=ny;

  // pits (H/R)
  for(const p of pits){
    if(Math.hypot(ball.x-p.x,ball.y-p.y) < p.r-ball.r*.1){
      ball.vx=ball.vy=0; ball.x=start.x; ball.y=start.y; navigator.vibrate&&navigator.vibrate(18);
      playSound('sndFail');
    }
  }

  // Fire (burn + reset)
  for(const f of fires){
    if (Math.hypot(ball.x-f.x, ball.y-f.y) < f.r - ball.r*0.05){
      ball.vx=ball.vy=0; ball.x=start.x; ball.y=start.y;
      navigator.vibrate&&navigator.vibrate([20,30,20]);
      playSound('sndBurn');
    }
  }

  // Teleporters (pair jump with cooldown)
  if (teleCooldown > 0) teleCooldown -= dt;
  else {
    for (let i=0;i<teleporters.length;i++){
      const t = teleporters[i];
      if (Math.hypot(ball.x-t.x, ball.y-t.y) < t.r - ball.r*0.05){
        const pair = teleporters[t.pair];
        if (pair){
          ball.x = pair.x + (ball.r*0.6);
          ball.y = pair.y + (ball.r*0.6);
          ball.vx *= 0.5; ball.vy *= 0.5;
          teleCooldown = 0.45;
          navigator.vibrate&&navigator.vibrate(35);
        }
        break;
      }
    }
  }

  // Goal
  if(Math.hypot(ball.x-goal.x,ball.y-goal.y) < (goal.r-ball.r*0.15)){
    falling=true; fallT=0; ball.vx=ball.vy=0; navigator.vibrate&&navigator.vibrate([40,40,40]);
  }
}

/* draw */
function rr(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function draw(){
  // themed background
  const bg=ctx.createLinearGradient(0,0,canvas.width,canvas.height);
  bg.addColorStop(0,THEME.bg1); bg.addColorStop(1,THEME.bg2);
  ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height);

  /* bricks */
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,.55)'; ctx.shadowBlur=14; ctx.shadowOffsetY=7;
  const m=Math.floor(cell*0.08);
  for(const w of walls){
    const x=w.x+m, y=w.y+m, ww=w.w-2*m, hh=w.h-2*m;
    const r=Math.floor(Math.min(ww,hh)*0.22);
    rr(x,y,ww,hh,r);
    const g1=ctx.createLinearGradient(x,y,x+ww,y+hh);
    g1.addColorStop(0,THEME.brick1); g1.addColorStop(1,THEME.brick2);
    ctx.fillStyle=g1; ctx.fill();
    ctx.lineWidth=Math.max(1,Math.floor(cell*0.05));
    ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.stroke();
    ctx.save(); ctx.clip();
    const g2=ctx.createLinearGradient(x,y,x,y+hh);
    g2.addColorStop(0,'rgba(255,255,255,.10)');
    g2.addColorStop(.4,'rgba(255,255,255,.02)');
    g2.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g2; ctx.fillRect(x,y,ww,hh);
    ctx.restore();
    ctx.beginPath(); rr(x+1,y+1,ww-2,hh-2,r-2);
    ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.lineWidth=Math.max(1,Math.floor(cell*0.03)); ctx.stroke();
  }
  ctx.restore();

  /* pits */
  for(const p of pits){
    let g=ctx.createRadialGradient(p.x,p.y,p.r*0.4,p.x,p.y,p.r*1.15);
    g.addColorStop(0,'rgba(0,0,0,.6)'); g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r*1.15,0,TAU); ctx.fill();

    g=ctx.createRadialGradient(p.x,p.y,2,p.x,p.y,p.r);
    g.addColorStop(0,'#0a0705'); g.addColorStop(1,'#000');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,TAU); ctx.fill();

    let glow1=p.red?'rgba(255,80,80,.45)':'rgba(255,232,150,.28)';
    let glow2=p.red?'rgba(255,80,80,0)' :'rgba(255,232,150,0)';
    g=ctx.createRadialGradient(p.x,p.y,p.r*0.7,p.x,p.y,p.r*1.3);
    g.addColorStop(0,glow1); g.addColorStop(1,glow2);
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,p.r*1.3,0,TAU); ctx.fill();
  }

  /* NEW: Fire ðŸ”¥ */
  const tNow = performance.now() * 0.001;
  fires.forEach((f,i)=>{
    const w = f.r * (1.10 + 0.08*Math.sin(tNow*6 + (f.animSeed||0)));
    const g1 = ctx.createRadialGradient(f.x, f.y, f.r*0.15, f.x, f.y, w);
    g1.addColorStop(0,'rgba(255,240,200,0.95)');
    g1.addColorStop(0.4,'rgba(255,140,40,0.8)');
    g1.addColorStop(1,'rgba(255,0,0,0.0)');
    ctx.fillStyle=g1; ctx.beginPath(); ctx.arc(f.x,f.y,w,0,TAU); ctx.fill();
    ctx.save();
    ctx.font = Math.floor(cell*0.6)+'px system-ui, Apple Color Emoji, Segoe UI Emoji';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.globalAlpha = 0.95;
    ctx.fillText('ðŸ”¥', f.x, f.y - Math.sin(tNow*7 + i)*2);
    ctx.restore();
  });

  /* NEW: Teleporters ðŸš« */
  teleporters.forEach((t,idx)=>{
    const g2 = ctx.createRadialGradient(t.x,t.y,t.r*0.3,t.x,t.y,t.r*1.2);
    g2.addColorStop(0,'rgba(180,220,255,0.85)');
    g2.addColorStop(1,'rgba(50,100,200,0.0)');
    ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(t.x,t.y,t.r*1.2,0,TAU); ctx.fill();
    ctx.save();
    ctx.font = Math.floor(cell*0.55)+'px system-ui, Apple Color Emoji, Segoe UI Emoji';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('ðŸš«', t.x, t.y);
    ctx.restore();
  });

  /* START marker (neon blue) */
  if(start){
    let g=ctx.createRadialGradient(start.x,start.y,2,start.x,start.y,cell*0.5);
    g.addColorStop(0,'rgba(80,230,255,.9)');
    g.addColorStop(1,'rgba(80,230,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(start.x,start.y,cell*0.5,0,TAU); ctx.fill();
    ctx.beginPath(); ctx.arc(start.x,start.y,cell*0.18,0,TAU);
    ctx.fillStyle='rgba(160,250,255,.8)'; ctx.fill();
  }

  /* END (goal) â€” red glow hole */
  const rimR=goal.r*1.12;
  let g=ctx.createRadialGradient(goal.x,goal.y,goal.r*0.2,goal.x,goal.y,rimR);
  g.addColorStop(0,'rgba(0,0,0,.7)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g;
  ctx.beginPath(); ctx.arc(goal.x,goal.y,rimR,0,TAU); ctx.fill();
  g=ctx.createRadialGradient(goal.x,goal.y,2,goal.x,goal.y,goal.r);
  g.addColorStop(0,'#1b0b0b'); g.addColorStop(1,'#000'); ctx.fillStyle=g;
  ctx.beginPath(); ctx.arc(goal.x,goal.y,goal.r,0,TAU); ctx.fill();
  g=ctx.createRadialGradient(goal.x,goal.y,goal.r*0.7,goal.x,goal.y,goal.r*1.35);
  g.addColorStop(0,'rgba(255,80,80,.75)'); g.addColorStop(1,'rgba(255,80,80,0)'); ctx.fillStyle=g;
  ctx.beginPath(); ctx.arc(goal.x,goal.y,goal.r*1.35,0,TAU); ctx.fill();

  /* ball */
  ctx.beginPath();ctx.arc(ball.x+ball.r*.16,ball.y+ball.r*.26,ball.r*.94,0,TAU);ctx.fillStyle='rgba(0,0,0,.36)';ctx.fill();
  const metal=ctx.createRadialGradient(ball.x-ball.r*.26,ball.y-ball.r*.26,ball.r*.18,ball.x,ball.y,ball.r);
  metal.addColorStop(0,'#fff');metal.addColorStop(.3,'#e0e4e9');metal.addColorStop(.6,'#9da3a8');metal.addColorStop(1,'#6e7378');
  ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,TAU);ctx.fillStyle=metal;ctx.fill();
}

/* loop */
let last=0;function startLoop(){last=0;requestAnimationFrame(loop);}
function loop(ts){if(!last)last=ts;const dt=Math.min(.032,(ts-last)/1000);last=ts;if(running){elapsed=performance.now()-t0;step(dt);$('time').textContent=(elapsed/1000).toFixed(1);}draw();requestAnimationFrame(loop);}

/* win & UI */
function win(){
  playSound('sndWin');
  running=false;
  const sec=elapsed/1000,base=8+level*2.6;let stars=1;
  if(sec<=base)stars=3;else if(sec<=base*1.65)stars=2;
  $('winTitle').textContent=(level===LEVELS.length-1)?'All levels complete!':'Level complete!';
  $('winInfo').textContent=`Level ${level+1} â€¢ Time ${sec.toFixed(2)}s`;
  $('winStars').textContent='â˜…'.repeat(stars)+'â˜†'.repeat(3-stars);
  $('win').classList.remove('hidden');
  navigator.vibrate&&navigator.vibrate([60,30,60]);
  const cur=level+1;
  if(unlocked<cur+1){unlocked=cur+1;localStorage.setItem('bm_unlocked',String(unlocked));}
  localStorage.setItem('bm_continue',String(cur+1));
}
function wireUI(){
  $('btnSettings').onclick=()=>$('settings').classList.remove('hidden');
  $('btnCloseSet').onclick=()=>$('settings').classList.add('hidden');
  $('btnEnableMotion').onclick=async()=>{try{await requestMotion();}catch{} addEventListener('deviceorientation',handleOrientation,true); addEventListener('devicemotion',handleMotion,true); alert('Motion enabled. Tilt phone. You can still drag anywhere.');};
  $('btnCal').onclick=()=>{
    offsetX = window._rawAX || 0; offsetY = window._rawAY || 0;
    localStorage.setItem('bm_offX', String(offsetX)); localStorage.setItem('bm_offY', String(offsetY));
    alert('Calibrated to your current hold.');
  };
  $('sens').oninput=e=>sens=parseFloat(e.target.value);

  const btnInput = $('btnInputMode');
  const refreshInputLabel = () => { btnInput.dataset.mode = inputMode; btnInput.textContent = 'Input: ' + (inputMode === 'tilt' ? 'Tilt' : 'Manual'); };
  refreshInputLabel();
  btnInput.onclick = () => { inputMode = (inputMode === 'tilt') ? 'manual' : 'tilt'; localStorage.setItem('bm_input', inputMode); refreshInputLabel(); };

  $('btnReset').onclick=()=>{if(confirm('Reset saved progress?')){localStorage.removeItem('bm_unlocked');localStorage.removeItem('bm_continue');unlocked=1;alert('Progress reset.');}};
  $('btnPreview').onclick=()=>{drawPreview(LEVELS[level],$('previewBox'));$('previewText').textContent=`Previewing level ${level+1}`;$('preview').classList.remove('hidden');};
  $('btnClosePrev').onclick=()=>$('preview').classList.add('hidden');
  $('btnStartLvl').onclick=()=>{$('preview').classList.add('hidden');running=true;t0=performance.now();};
  $('btnLevels').onclick=()=>{fillGrid();$('levels').classList.remove('hidden');};
  $('btnCloseLevels').onclick=()=>$('levels').classList.add('hidden');
  $('btnContinue').onclick=()=>{const cont=clamp((parseInt(localStorage.getItem('bm_continue')||String(unlocked),10)-1),0,LEVELS.length-1);build(cont);running=true;t0=performance.now();};
  $('btnRestart').onclick=()=>{build(level);running=true;t0=performance.now();};
  $('btnPrev').onclick=()=>{build(clamp(level-1,0,LEVELS.length-1));running=true;t0=performance.now();};
  $('btnNext').onclick=()=>{const n=clamp(level+1,0,LEVELS.length-1);if(n+1>unlocked)return alert('Finish current level to unlock next.');build(n);running=true;t0=performance.now();};
  $('btnNextWin').onclick=()=>{$('win').classList.add('hidden');build(clamp(level+1,0,LEVELS.length-1));running=true;t0=performance.now();};
  $('btnCloseWin').onclick=()=>$('win').classList.add('hidden');
}

/* input */
function wireInput(){
  const dpr=()=>window.devicePixelRatio||1;
  const pos=(e)=>{const r=canvas.getBoundingClientRect();let cx,cy;if(e.touches&&e.touches.length){cx=e.touches[0].clientX;cy=e.touches[0].clientY;}else{cx=('clientX'in e)?e.clientX:0;cy=('clientY'in e)?e.clientY:0;}return {x:(cx-r.left)*dpr(),y:(cy-r.top)*dpr()};};
  const startDrag=e=>{dragging=true;dragTarget=pos(e);e.preventDefault();};
  const moveDrag =e=>{if(!dragging)return;dragTarget=pos(e);e.preventDefault();};
  const endDrag  =()=>{dragging=false;dragTarget=null;};
  canvas.addEventListener('pointerdown',startDrag,{passive:false});
  canvas.addEventListener('pointermove',moveDrag,{passive:false});
  canvas.addEventListener('pointerup',endDrag,{passive:false});
  canvas.addEventListener('touchstart',startDrag,{passive:false});
  canvas.addEventListener('touchmove',moveDrag,{passive:false});
  canvas.addEventListener('touchend',endDrag,{passive:false});
  canvas.addEventListener('mousedown',startDrag);
  window.addEventListener('mousemove',moveDrag);
  window.addEventListener('mouseup',endDrag);
}

/* grid + preview */
function fillGrid(){const g=$('grid');g.innerHTML='';for(let i=0;i<LEVELS.length;i++){const d=document.createElement('div');d.className='cell'+(((i+1)<=unlocked)?'':' lock');d.textContent=i+1;d.onclick=()=>{if((i+1)>unlocked){alert('Locked');return;}build(i);$('levels').classList.add('hidden');running=true;t0=performance.now();};g.appendChild(d);}}
function drawPreview(arr,box){
  const DPR=window.devicePixelRatio||1;const w=box.clientWidth*DPR,h=box.clientHeight*DPR;
  const c=box.querySelector('canvas')||document.createElement('canvas');if(!c.parentNode)box.appendChild(c);
  c.width=w;c.height=h;c.style.width=box.clientWidth+'px';c.style.height=box.clientHeight+'px';
  const g=c.getContext('2d');const R=arr.length,C=arr[0].length;
  const pad=Math.min(w,h)*.06;const cell=Math.floor((Math.min(w,h)-pad*2)/Math.max(R,C));
  const sx=Math.floor((w-cell*C)/2),sy=Math.floor((h-cell*R)/2);
  g.fillStyle='#0b1620';g.fillRect(0,0,w,h);
  for(let r=0;r<R;r++)for(let c0=0;c0<C;c0++){
    const ch=arr[r][c0],x=sx+c0*cell,y=sy+r*cell;
    if(ch=='#'){
      const mm=Math.floor(cell*0.10),rx=x+mm,ry=y+mm,ww=cell-2*mm,hh=cell-2*mm,rad=Math.floor(Math.min(ww,hh)*0.22);
      g.fillStyle=THEME.brick1;g.beginPath();
      g.moveTo(rx+rad,ry);g.arcTo(rx+ww,ry,rx+ww,ry+hh,rad);
      g.arcTo(rx+ww,ry+hh,rx,ry+hh,rad);
      g.arcTo(rx,ry+hh,rx,ry,rad);
      g.arcTo(rx,ry,rx+ww,ry,rad);
      g.closePath();g.fill();
    }else{
      if(ch==='R'){ g.fillStyle='#7a1a1a'; }
      else if(ch==='H'){ g.fillStyle='#2b1f18'; }
      else if(ch==='G'){ g.fillStyle='#ff6060'; }
      else if(ch==='S'){ g.fillStyle='#4fe6ff'; }
      else if(ch==='F'){ g.fillStyle='#5a2a10'; }
      else if(ch==='T'){ g.fillStyle='#1a2a5a'; }
      else { g.fillStyle='#142a36'; }
      g.fillRect(x,y,cell,cell);
    }
  }
}

addEventListener('beforeunload',()=>{try{localStorage.setItem('bm_continue',String(level+1));}catch(e){}});
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js?v=20250816a', {scope: './',updateViaCache: 'none'})
      .catch(err => console.log('SW registration failed:', err));
  });
}
</script>
</body>
</html>